default_platform :mac

after_all do
  debug
end

platform :mac do
  lane :bump do
    prompt_bump_and_changelog
  end

  lane :clean do
    FileUtils.rm_rf("../build")
  end

  lane :release do
    ensure_git_status_clean
    ensure_git_branch(branch: 'master')

    clean

    prompt_bump_and_changelog(read_only: true)
    version = Actions.lane_context[SharedValues::PROMPT_BUMP_AND_CHANGELOG_VERSION]
    changelog = Actions.lane_context[SharedValues::PROMPT_BUMP_AND_CHANGELOG_CHANGELOG_CONTENT]

    puts "version: #{version}"
    puts "changelog: #{changelog}"

    add_git_tag(tag: get_version_number)
    push_git_tags

    release_app_store
    release_developer_id

    version = last_git_tag
    github_release = set_github_release(
      name: version,
      tag_name: version,
      description: options[:description],
      commitish: "master",
      upload_assets: [developer_id_app_path]
    )
  end

  lane :release_app_store do
    match(
      type: 'appstore',
      additional_cert_types: [ 'mac_installer_distribution' ]
    )

    fix_single_target_signing(code_sign_identity: "Apple Distribution")
    gym(
      scheme: 'CrunchyGIF',
      output_directory: 'build/appstore',
      export_method: 'app-store',
    )

    deliver
  end

  lane :release_developer_id do
    match(
      type: 'developer_id',
      git_branch: 'last-good-developer_id',
      additional_cert_types: [ 'developer_id_installer' ]
    )

    fix_single_target_signing(code_sign_identity: "Developer ID Application")
    gym(
      scheme: 'CrunchyGIFDeveloperID',
      export_method: 'developer-id',
      output_directory: 'build/developerid',
      skip_package_pkg: true
    )

    notarize(
      package: develop_id_app_path
    )
  end

  private_lane :developer_id_app_path do
    app_path = Dir.glob("../build/developerid/*.app").first
    File.absolute_path(app_path)
  end
end
